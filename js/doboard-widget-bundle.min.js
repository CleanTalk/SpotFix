let DOBOARD_API_URL="https://api-next.doboard.com",userConfirmEmailDoboard=async e=>{e=await fetch(DOBOARD_API_URL+"/user_confirm_email?email_confirmation_token="+encodeURIComponent(e),{method:"GET"});if(!e.ok)throw new Error("Email confirmation failed");e=await e.json();if(!e||!e.data)throw new Error("Invalid response from server");if("CONFIRMED"!==e.data.operation_status)throw new Error("Email not confirmed");return{sessionId:e.data.session_id,userId:e.data.user_id,email:e.data.email,accounts:e.data.accounts,operationStatus:e.data.operation_status}},createTaskDoboard=async(e,t)=>{var a=t.accountId,s=new FormData,e=(s.append("session_id",e),s.append("project_token",t.projectToken),s.append("project_id",t.projectId),s.append("user_id",localStorage.getItem("spotfix_user_id")),s.append("name",t.taskTitle),s.append("comment",t.taskDescription),s.append("meta",t.taskMeta),s.append("task_type","PUBLIC"),await fetch(DOBOARD_API_URL+"/"+a+"/task_add",{method:"POST",body:s}));if(!e.ok)throw new Error("Failed to create task");t=await e.json();if(!t||!t.data)throw new Error("Invalid response from server");if("FAILED"===t.data.operation_status)throw new Error(t.data.operation_message);if("SUCCESS"===t.data.operation_status)return{taskId:t.data.task_id,isPublic:1};throw new Error("Unknown error occurred during creating task")},createTaskCommentDoboard=async(e,t,a,s,r,o="ACTIVE")=>{e=await fetch(DOBOARD_API_URL+"/"+e+"/comment_add?session_id="+t+"&task_id="+a+"&comment="+s+"&project_token="+r+"&status="+o,{method:"GET"});if(!e.ok)throw new Error("Failed to create task comment");t=await e.json();if(!t||!t.data)throw new Error("Invalid response from server");if("FAILED"===t.data.operation_status)throw new Error(t.data.operation_message);if("SUCCESS"===t.data.operation_status)return{commentId:t.data.comment_id};throw new Error("Unknown error occurred during creating task comment")},registerUserDoboard=async(e,t,a,s,r)=>{var o=new FormData,e=(o.append("project_token",e),o.append("account_id",t),o.append("confirmation_url",r),a&&s&&(o.append("email",a),o.append("name",s)),await fetch(DOBOARD_API_URL+"/user_registration",{method:"POST",body:o}));if(!e.ok)throw new Error("Registration failed");t=await e.json();if(!t||!t.data)throw new Error("Invalid response from server");if("FAILED"===t.data.operation_status)throw new Error(t.data.operation_message);if("SUCCESS"===t.data.operation_status)return{sessionId:t.data.session_id,userId:t.data.user_id,email:t.data.email,accountExists:1===t.data.user_email_confirmed,operationMessage:t.data.operation_message,operationStatus:t.data.operation_status,userEmailConfirmed:t.data.user_email_confirmed};throw new Error("Unknown error occurred during registration")},loginUserDoboard=async(e,t)=>{var a=new FormData,e=(a.append("email",e),a.append("password",t),await fetch(DOBOARD_API_URL+"/user_authorize",{method:"POST",body:a}));if(!e.ok)throw new Error("Authorization failed");t=await e.json();if(!t||!t.data)throw new Error("Invalid response from server");if("FAILED"===t.data.operation_status)throw new Error(t.data.operation_message);if("SUCCESS"===t.data.operation_status)return{sessionId:t.data.session_id,userId:t.data.user_id,email:t.data.email,accountExists:1===t.data.user_email_confirmed,operationMessage:t.data.operation_message,operationStatus:t.data.operation_status,userEmailConfirmed:t.data.user_email_confirmed};throw new Error("Unknown error occurred during registration")},getTasksDoboard=async(e,t,a,s,r)=>{var o=new FormData,e=(o.append("project_token",e),o.append("session_id",t),o.append("project_id",s),o.append("status","ACTIVE"),o.append("task_type","PUBLIC"),r&&o.append("user_id",r),await fetch(DOBOARD_API_URL+"/"+a+"/task_get",{method:"POST",body:o}));if(!e.ok)throw new Error("Getting tasks failed");t=await e.json();if(!t||!t.data)throw new Error("Invalid response from server");if("FAILED"===t.data.operation_status)throw new Error(t.data.operation_message);if("SUCCESS"===t.data.operation_status)return t.data.tasks.map(e=>({taskId:e.task_id,taskTitle:e.name,taskLastUpdate:e.updated,taskCreated:e.created,taskCreatorTaskUser:e.creator_user_id,taskMeta:e.meta}));throw new Error("Unknown error occurred during getting tasks")},getTaskCommentsDoboard=async(e,t,a,s,r="ACTIVE")=>{a=await fetch(DOBOARD_API_URL+"/"+a+"/comment_get?session_id="+t+"&status="+r+"&task_id="+e+"&project_token="+s,{method:"GET"});if(!a.ok)throw new Error("Getting logs failed");t=await a.json();if(!t||!t.data)throw new Error("Invalid response from server");if("FAILED"===t.data.operation_status)throw new Error(t.data.operation_message);if("SUCCESS"===t.data.operation_status)return t.data.comments.map(e=>({commentId:e.comment_id,userId:e.user_id,comment:e.comment,commentBody:e.comment_text,commentDate:e.updated,status:e.status,issueTitle:e.task_name}));throw new Error("Unknown error occurred during getting comments")},getUserDoboard=async(e,t,a)=>{a=await fetch(DOBOARD_API_URL+"/"+a+"/user_get?session_id="+e+"&project_token="+t,{method:"GET"});if(!a.ok)throw new Error("Getting user failed");e=await a.json();if(!e)throw new Error("Invalid response from server");if(e.data&&e.data.operation_status){if("FAILED"===e.data.operation_status)throw new Error(e.data.operation_message);if("SUCCESS"===e.data.operation_status)return Array.isArray(e.data.users)?e.data.users:[]}if(e.operation_status){if("FAILED"===e.operation_status)throw new Error(e.operation_message);if("SUCCESS"===e.operation_status)return Array.isArray(e.users)?e.users:[]}throw new Error("Unknown error occurred during getting user")},userUpdateDoboard=async(e,t,a,s,r)=>{t=await fetch(DOBOARD_API_URL+"/"+t+"/user_update?session_id="+a+"&project_token="+e+"&user_id="+s+"&timezone="+r,{method:"GET"});if(!t.ok)throw new Error("User update failed");a=await t.json();if(!a||!a.data)throw new Error("Invalid response from server");if("FAILED"===a.data.operation_status)throw new Error(a.data.operation_message);if("SUCCESS"===a.data.operation_status)return{success:!0};throw new Error("Unknown error occurred during user update")};async function confirmUserEmail(e,t){var e=await userConfirmEmailDoboard(e),a=(localStorage.setItem("spotfix_email",e.email),localStorage.setItem("spotfix_session_id",e.sessionId),localStorage.setItem("spotfix_user_id",e.userId),localStorage.getItem("spotfix_pending_task"));if(a)return t={taskTitle:(a=JSON.parse(a)).selectedText||"New Task",taskDescription:a.description||"",selectedData:a,projectToken:t.projectToken,projectId:t.projectId,accountId:t.accountId,taskMeta:JSON.stringify(a)},a=await handleCreateTask(e.sessionId,t),localStorage.removeItem("spotfix_pending_task"),a;throw new Error("No pending task data")}async function getTaskFullDetails(e,t){var a=localStorage.getItem("spotfix_session_id"),s=await getTaskCommentsDoboard(t,a,e.accountId,e.projectToken);let r=await getUserDoboard(a,e.projectToken,e.accountId),o=0<s.length?s[0]:null,i=null,n=(o&&r&&0<r.length&&(i=r.find(e=>String(e.user_id)===String(o.userId))),"");return o&&((a=formatDate(o.commentDate)).date,n=a.time),{taskId:t,taskAuthorAvatarImgSrc:getAvatarSrc(i),taskAuthorName:getAuthorName(i),lastMessageText:o?o.commentBody:"No messages yet",lastMessageTime:n,issueTitle:0<s.length?s[0].issueTitle:"No Title",issueComments:s.sort((e,t)=>new Date(e.commentDate)-new Date(t.commentDate)).map(t=>{var{date:e,time:a}=formatDate(t.commentDate);let s=null;return{commentAuthorAvatarSrc:getAvatarSrc(s=r&&0<r.length?r.find(e=>String(e.user_id)===String(t.userId)):s),commentAuthorName:getAuthorName(s),commentBody:t.commentBody,commentDate:e,commentTime:a,commentUserId:t.userId||"Unknown User"}})}}async function handleCreateTask(e,t){try{var a=await createTaskDoboard(e,t);return a&&a.taskId&&t.taskDescription&&await addTaskComment({projectToken:t.projectToken,accountId:t.accountId},a.taskId,t.taskDescription),a}catch(e){throw e}}async function addTaskComment(e,t,a){var s=localStorage.getItem("spotfix_session_id");if(!s)throw new Error("No session");if(e.projectToken&&e.accountId)return createTaskCommentDoboard(e.accountId,s,t,a,e.projectToken);throw new Error("Missing params")}function getUserTasks(e){var t,a,s;return localStorage.getItem("spotfix_session_id")?(t=e.projectToken,a=localStorage.getItem("spotfix_session_id"),s=localStorage.getItem("spotfix_user_id"),getTasksDoboard(t,a,e.accountId,e.projectId,s)):{}}async function getAllTasks(e){var t,a;return localStorage.getItem("spotfix_session_id")?(t=e.projectToken,a=localStorage.getItem("spotfix_session_id"),(await getTasksDoboard(t,a,e.accountId,e.projectId)).filter(e=>e.taskMeta)):{}}function formatDate(e){if(!e)return{date:"",time:""};let t;return t=!e.includes("T")&&e.includes(" ")?new Date(e.replace(" ","T")):new Date(e),isNaN(t.getTime())?{date:"",time:""}:(e=t.getTimezoneOffset(),{date:["January","February","March","April","May","June","July","August","September","October","November","December"][(e=new Date(t.getTime()-6e4*e)).getMonth()]+" "+e.getDate(),time:e.getHours().toString().padStart(2,"0")+":"+e.getMinutes().toString().padStart(2,"0")})}function getTaskAuthorDetails(e,t){localStorage.getItem("spotfix_session_id");var a=[{taskId:"1",taskAuthorAvatarImgSrc:"https://s3.eu-central-1.amazonaws.com/cleantalk-ctask-atts/accounts/1/avatars/081a1b65d20fe318/m.jpg",taskAuthorName:"Test All Issues Single Author Name"}].find(e=>e.taskId===t);return void 0===a?{taskId:null,taskAuthorAvatarImgSrc:null,taskAuthorName:"Task Author"}:a}function getIssuesCounterString(e,t){return`(${e}/${t})`}function getAvatarSrc(e){if(e&&e.avatar){if("object"==typeof e.avatar&&e.avatar.m)return e.avatar.m;if("string"==typeof e.avatar)return e.avatar}return null}function getAuthorName(e){if(e){if(e.name&&0<e.name.trim().length)return e.name;if(e.email&&0<e.email.trim().length)return e.email}return"Unknown Author"}function registerUser(e){let a=e.userEmail,s=e.userName,r=e.projectToken,o=e.accountId,i=e.selectedData.pageURL||window.location.href;return t=>registerUserDoboard(r,o,a,s,i).then(e=>{if(console.log(e),e.accountExists)document.querySelector(".doboard_task_widget-accordion>.doboard_task_widget-input-container").innerText="Account already exists. Please, login usin your password.",document.querySelector(".doboard_task_widget-accordion>.doboard_task_widget-input-container.hidden").classList.remove("hidden"),document.getElementById("doboard_task_widget-user_password").focus();else if(e.sessionId)localStorage.setItem("spotfix_session_id",e.sessionId),localStorage.setItem("spotfix_user_id",e.userId),localStorage.setItem("spotfix_email",e.email),userUpdate(r,o);else{if(!("SUCCESS"===e.operationStatus&&e.operationMessage&&0<e.operationMessage.length))throw new Error("Session ID not found in response");"Waiting for email confirmation"==e.operationMessage&&(e.operationMessage="Waiting for an email confirmation. Please check your Inbox."),"function"==typeof t&&t(e.operationMessage,"notice")}}).catch(e=>{throw e})}function loginUser(e){let a=e.userEmail,s=e.userPassword;return t=>loginUserDoboard(a,s).then(e=>{if(e.sessionId)localStorage.setItem("spotfix_session_id",e.sessionId),localStorage.setItem("spotfix_user_id",e.userId),localStorage.setItem("spotfix_email",e.email);else{if(!("SUCCESS"===e.operationStatus&&e.operationMessage&&0<e.operationMessage.length))throw new Error("Session ID not found in response");"function"==typeof t&&t(e.operationMessage,"notice")}}).catch(e=>{throw e})}function userUpdate(e,t){var a=localStorage.getItem("spotfix_session_id"),s=localStorage.getItem("spotfix_user_id"),r=Intl.DateTimeFormat().resolvedOptions().timeZone;return userUpdateDoboard(e,t,a,s,r)}class CleanTalkWidgetDoboard{selectedText="";selectedData={};widgetElement=null;params={};currentActiveTaskId=0;savedIssuesQuantityOnPage=0;savedIssuesQuantityAll=0;allTasksData={};constructor(e,t){this.selectedData=e,this.selectedText=e.selectedText,this.init(t)}async init(e){this.params=this.getParams();var t=new URLSearchParams(window.location.search),a=t.get("email_confirmation_token");if(a)try{var s=await confirmUserEmail(a,this.params),r=(this.allTasksData=await getAllTasks(this.params),this.currentActiveTaskId=s.taskId,storageSetWidgetIsClosed(!(e="concrete_issue")),t.delete("email_confirmation_token"),window.location.pathname+(t.toString()?"?"+t.toString():""));window.history.replaceState({},document.title,r)}catch(e){this.registrationShowMessage("Error confirming email: "+e.message,"error")}else this.allTasksData=await getAllTasks(this.params);let o;storageTasksHasUnreadUpdates()?o=!0:"wrap"===e&&(o=await checkIfTasksHasSiteOwnerUpdates(this.allTasksData,this.params)),storageSaveTasksUpdateData(this.allTasksData),storageWidgetCloseIsSet()||storageSetWidgetIsClosed(!0),o&&storageSetWidgetIsClosed(!1),this.widgetElement=await this.createWidgetElement(e),this.bindWidgetInputsInteractive()}getParams(){var e=document.querySelector('script[src*="doboard-widget-bundle.min.js"]');if(!e||!e.src)throw new Error("Script not provided");e=new URL(e.src),e=Object.fromEntries(e.searchParams.entries());if(!e)throw new Error("Script params not provided");if(e.projectToken&&e.accountId&&e.projectId)return e;throw new Error("Necessary script params not provided")}bindCreateTaskEvents(){var e=document.getElementById("doboard_task_widget-submit_button");e&&e.addEventListener("click",async()=>{var e=document.getElementById("doboard_task_widget-title"),o=e.value;if(o){var t=document.getElementById("doboard_task_widget-description"),i=t.value;if(i){let t="",a="",s="";var n=document.querySelector(".doboard_task_widget-login");if(n&&n.classList.contains("active")){let e=document.getElementById("doboard_task_widget-user_email");var n=document.getElementById("doboard_task_widget-user_name"),d=document.getElementById("doboard_task_widget-user_password");if(!(a=e.value))return e.style.borderColor="red",e.focus(),void e.addEventListener("input",function(){this.style.borderColor=""});if(e&&n&&!(t=n.value))return n.style.borderColor="red",n.focus(),void n.addEventListener("input",function(){this.style.borderColor=""});if(e&&d&&!n&&!(s=d.value))return d.style.borderColor="red",d.focus(),void d.addEventListener("input",function(){this.style.borderColor=""})}let e=document.getElementById("doboard_task_widget-user_email");a=e.value;n=document.getElementById("doboard_task_widget-submit_button"),d=(n.disabled=!0,n.innerText="Creating spot...",{taskTitle:o,taskDescription:i,selectedData:this.selectedData,projectToken:this.params.projectToken,projectId:this.params.projectId,accountId:this.params.accountId,taskMeta:JSON.stringify(this.selectedData)});a&&(d.userEmail=a),t&&(d.userName=t),s&&(d.userPassword=s),localStorage.setItem("spotfix_pending_task",JSON.stringify({...this.selectedData,description:i}));let r;try{r=await this.submitTask(d)}catch(e){return void this.registrationShowMessage(e.message)}n.disabled=!1,n.style.cursor="pointer",r.needToLogin||(void 0!==r.isPublic&&(this.selectedData.isPublic=r.isPublic),this.allTasksData=await getAllTasks(this.params),storageSaveTasksUpdateData(this.allTasksData),this.selectedData={},await this.createWidgetElement("all_issues"),storageSetWidgetIsClosed(!1),hideContainersSpinner(!1))}else t.style.borderColor="red",t.focus(),t.addEventListener("input",function(){this.style.borderColor=""})}else e.style.borderColor="red",e.focus(),e.addEventListener("input",function(){this.style.borderColor=""})})}async createWidgetElement(e,i=!0){var n=document.querySelector(".doboard_task_widget")?document.querySelector(".doboard_task_widget"):document.createElement("div");n.className="doboard_task_widget",n.innerHTML="",n.removeAttribute("style");let t="",d={};switch(e){case"create_issue":t="create_issue",d={selectedText:this.selectedText,currentDomain:document.location.hostname||""},storageGetUserIsDefined()&&storageSetWidgetIsClosed(!1);break;case"wrap":if(storageGetWidgetIsClosed())return;t="wrap";break;case"all_issues":t="all_issues";break;case"concrete_issue":t="concrete_issue",this.savedIssuesQuantityAll=Array.isArray(this.allTasksData)?this.allTasksData.length:0,this.savedIssuesQuantityOnPage=Array.isArray(this.allTasksData)?this.allTasksData.filter(e=>{try{return(e.taskMeta?JSON.parse(e.taskMeta):{}).pageURL===window.location.href}catch(e){return!1}}).length:0,d={issueTitle:"...",issuesCounter:getIssuesCounterString(this.savedIssuesQuantityOnPage,this.savedIssuesQuantityAll),paperclipImgSrc:"/spotfix/img/send-message--paperclip.svg",sendButtonImgSrc:"/spotfix/img/send-message--button.svg",msgFieldBackgroundImgSrc:"/spotfix/img/send-message--input-background.svg"}}switch(n.innerHTML=await this.loadTemplate(t,d),document.body.appendChild(n),this.removeHighlights(),e){case"create_issue":var l=window.getSelection();"Range"===l.type&&(l=getSelectedData(l),this.highlightElements([l]),scrollToNodePath(l.nodePath)),this.bindCreateTaskEvents();break;case"wrap":await this.getTaskCount(),document.querySelector(".doboard_task_widget-wrap").addEventListener("click",e=>{e=e.currentTarget.classList;e&&!e.contains("hidden")&&this.createWidgetElement("all_issues")}),hideContainersSpinner(!1);break;case"all_issues":this.removeHighlights();let s=0;var c=this.allTasksData,u=[];if(0<c.length){document.querySelector(".doboard_task_widget-all_issues-container").innerHTML="";for(let e=0;e<c.length;e++){var m=c[e],g=m.taskId,A=m.taskTitle,m=m.taskMeta,m=m?JSON.parse(m):null,p=m?m.pageURL:"",h=m?m.nodePath:"";let t="",a="Task publicity is unknown";if(m&&void 0!==m.isPublic&&(a=m.isPublic?(t="/spotfix/img/public.svg","The task is public"):(t="/spotfix/img/private.svg","The task is private and visible only for registered DoBoard users")),!i||p===window.location.href){s++;var p=await getTaskFullDetails(this.params,g),k=getAvatarData(p);let e={taskTitle:A||"",taskAuthorAvatarImgSrc:p.taskAuthorAvatarImgSrc,taskAuthorName:p.taskAuthorName,taskPublicStatusImgSrc:t,taskPublicStatusHint:a,taskLastMessage:p.lastMessageText,taskLastUpdate:p.lastMessageTime,nodePath:h,taskId:g,avatarCSSClass:k.avatarCSSClass,avatarStyle:k.avatarStyle,taskAuthorInitials:k.taskAuthorInitials,initialsClass:k.initialsClass,classUnread:""};storageProvidedTaskHasUnreadUpdates(p.taskId)&&(e.classUnread="unread"),document.querySelector(".doboard_task_widget-all_issues-container").innerHTML+=await this.loadTemplate("list_issues",e),u.push(m)}}this.savedIssuesQuantityOnPage=s,this.savedIssuesQuantityAll=c.length,this.highlightElements(u),document.querySelector(".doboard_task_widget-header span").innerText+=" "+getIssuesCounterString(this.savedIssuesQuantityOnPage,this.savedIssuesQuantityAll)}0!==c.length&&0!==s||(document.querySelector(".doboard_task_widget-all_issues-container").innerHTML='<div class="doboard_task_widget-issues_list_empty">The issues list is empty</div>'),this.bindIssuesClick(),hideContainersSpinner(!1);break;case"concrete_issue":let a=await getTaskFullDetails(this.params,this.currentActiveTaskId);l=document.querySelector(".doboard_task_widget-issue-title");l&&(l.innerText=a.issueTitle),d={issueTitle:a.issueTitle,issueComments:a.issueComments,issuesCounter:getIssuesCounterString(this.savedIssuesQuantityOnPage,this.savedIssuesQuantityAll),paperclipImgSrc:"/spotfix/img/send-message--paperclip.svg",sendButtonImgSrc:"/spotfix/img/send-message--button.svg",msgFieldBackgroundImgSrc:"/spotfix/img/send-message--input-background.svg"},n.innerHTML=await this.loadTemplate("concrete_issue",d),document.body.appendChild(n);let t=null;l=this.allTasksData.find(e=>String(e.taskId)===String(a.taskId));let r=null;if(l&&l.taskMeta)try{r=JSON.parse(l.taskMeta),t=r.nodePath||null}catch(e){t=null,r=null}this.removeHighlights(),r&&t&&(this.highlightElements([r]),"function"==typeof scrollToNodePath)&&scrollToNodePath(t);var l=document.querySelector(".doboard_task_widget-concrete_issues-container"),w=[],f=localStorage.getItem("spotfix_user_id");if(0<a.issueComments.length){storageRemoveUnreadUpdateForTaskID(a.taskId),l.innerHTML="";for(var _ of a.issueComments){var I=Number(f)===Number(_.commentUserId),v=getAvatarData({taskAuthorAvatarImgSrc:_.commentAuthorAvatarSrc,taskAuthorName:_.commentAuthorName,userIsIssuer:I}),I={commentAuthorName:_.commentAuthorName,commentBody:_.commentBody,commentDate:_.commentDate,commentTime:_.commentTime,issueTitle:d.issueTitle,commentContainerBackgroundSrc:I?"/spotfix/img/comment-self-background.png":"/spotfix/img/comment-other-background.png",avatarCSSClass:v.avatarCSSClass,avatarStyle:v.avatarStyle,taskAuthorInitials:v.taskAuthorInitials,initialsClass:v.initialsClass};void 0===w[_.commentDate]&&(w[_.commentDate]=[]),w[_.commentDate].push(I)}let t="";for(var S in w){var T,b=w[S];let e="";for(T in b.sort((e,t)=>e.commentTime.localeCompare(t.commentTime)),b){var E=b[T];e+=await this.loadTemplate("concrete_issue_messages",E)}t+=await this.loadTemplate("concrete_issue_day_content",{dayContentMonthDay:S,dayContentMessages:e})}l.innerHTML=t}else l.innerHTML="No comments";hideContainersSpinner(),setTimeout(()=>{var e=document.querySelector(".doboard_task_widget-content");e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},0);let o=document.querySelector(".doboard_task_widget-send_message form");o&&o.addEventListener("submit",async e=>{e.preventDefault();var e=o.querySelector(".doboard_task_widget-send_message_input"),t=e.value.trim();if(t){e.disabled=!0;try{await addTaskComment(this.params,this.currentActiveTaskId,t),e.value="",await this.createWidgetElement("concrete_issue"),hideContainersSpinner(!1)}catch(e){alert("Error when adding a comment: "+e.message)}e.disabled=!1}})}e=document.querySelector(".doboard_task_widget_return_to_all");let a=this;e&&e.addEventListener("click",function(e,t=a){t.createWidgetElement("all_issues")});e=document.querySelector(".doboard_task_widget-send_message_paperclip");return e&&e.addEventListener("click",function(e){e.preventDefault(),alert("This action is not implemented yet..")}),document.querySelector(".doboard_task_widget-close_btn")?.addEventListener("click",()=>{this.hide()}),document.querySelector("#doboard_task_widget-task_count")?.addEventListener("click",()=>{document.querySelector(".doboard_task_widget-wrap").classList.add("hidden"),storageSetWidgetIsClosed(!0)}),n}bindIssuesClick(){document.querySelectorAll(".issue-item").forEach(t=>{t.addEventListener("click",async()=>{scrollToNodePath(JSON.parse(t.getAttribute("data-node-path"))),this.currentActiveTaskId=t.getAttribute("data-task-id"),await this.createWidgetElement("concrete_issue");var e=this.getTaskHighlightData(this.currentActiveTaskId);e&&(this.removeHighlights(),this.highlightElements([e]),this.positionWidgetContainer()),hideContainersSpinner(!1)})})}async loadTemplate(t,e={}){let a=await(await fetch(`/spotfix/templates/${t}.html`)).text();var s,r;for([s,r]of Object.entries(e)){var o=`{{${s}}}`;let e=String(r).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");"concrete_issue_messages"!==t&&"concrete_issue_day_content"!==t||(e=r),a=a.replaceAll(o,e)}return a}async getTaskCount(){if(!localStorage.getItem("spotfix_session_id"))return{};var e=this.params.projectToken,t=localStorage.getItem("spotfix_session_id"),e=(await getTasksDoboard(e,t,this.params.accountId,this.params.projectId)).filter(e=>e.taskMeta),t=document.getElementById("doboard_task_widget-task_count");t&&(t.innerText=e.length,t.classList.remove("hidden"))}async submitTask(e){localStorage.getItem("spotfix_session_id")||(await registerUser(e)(this.registrationShowMessage),e.userPassword&&await loginUser(e)(this.registrationShowMessage));var t=localStorage.getItem("spotfix_session_id");return t?handleCreateTask(t,e):{needToLogin:!0}}hide(){this.removeHighlights(),this.createWidgetElement("wrap")}removeHighlights(){var e=document.querySelectorAll(".doboard_task_widget-text_selection");let a=new Set;e.forEach(e=>{var t=e.parentNode;for(a.add(t);e.firstChild;)t.insertBefore(e.firstChild,e);t.removeChild(e)}),a.forEach(e=>e.normalize())}wrapElementWithSpotfixHighlight(e){var t=e.cloneNode(),a=document.createElement("span");return a.className="doboard_task_widget-text_selection image-highlight",e.insertAdjacentElement("beforebegin",a),a.appendChild(t),a}getTaskHighlightData(t){var e=this.allTasksData.find(e=>e.taskId.toString()===t.toString());if(e&&void 0!==e.taskMeta){e=JSON.parse(e.taskMeta);if(null!==e&&"object"==typeof e)return e}return null}highlightElements(e){if(0!==e.length){let a=new Map;e.forEach(e=>{var t=retrieveNodeFromPath(e.nodePath);t&&(a.has(t)||a.set(t,[]),a.get(t).push(e))}),a.forEach((e,t)=>{var a=e[0].isTagOfImageType;!1!==a&&"IMG"===a&&(a=this.wrapElementWithSpotfixHighlight(t),t.replaceWith(a));let s=t.textContent,r=[],o=(e.forEach(e=>{e.isWholeTagSelected?(r.push({position:0,type:"start"}),r.push({position:s.length,type:"end"})):(r.push({position:e.startSelectPosition,type:"start"}),r.push({position:e.endSelectPosition,type:"end"}))}),r.sort((e,t)=>t.position-e.position),s);r.forEach(e=>{var t="start"===e.type?'<span class="doboard_task_widget-text_selection">':"</span>";o=o.slice(0,e.position)+t+o.slice(e.position)}),t.innerHTML=o})}}bindWidgetInputsInteractive(){document.querySelectorAll(".doboard_task_widget-field").forEach(e=>{e.value&&e.classList.add("has-value"),e.addEventListener("input",()=>{e.value?e.classList.add("has-value"):e.classList.remove("has-value")}),e.addEventListener("blur",()=>{e.value||e.classList.remove("has-value")})});var e=document.querySelector(".doboard_task_widget-login span");e&&e.addEventListener("click",function(){this.closest(".doboard_task_widget-login").classList.toggle("active")}),window.addEventListener("scroll",this.handleScroll.bind(this)),window.addEventListener("resize",this.handleResize.bind(this))}registrationShowMessage(e,t="error"){var a=document.getElementById("doboard_task_widget-error_message-header"),s=document.getElementById("doboard_task_widget-error_message"),r=document.querySelector(".doboard_task_widget-message-wrapper");"string"==typeof e&&null!==s&&null!==r&&(s.innerText=e,r.classList.remove("hidden"),s.classList.remove("doboard_task_widget-notice_message","doboard_task_widget-error_message"),"notice"===t?(a.innerText="",r.classList.add("doboard_task_widget-notice_message"),s.style.color="#2a5db0"):(a.innerText="Registration error",r.classList.add("doboard_task_widget-error_message"),s.style.color="red"))}positionWidgetContainer(){var t=document.querySelector(".doboard_task_widget-text_selection"),a=document.querySelector(".doboard_task_widget"),s=document.querySelector(".doboard_task_widget-content.doboard_task_widget-create_issue"),r=document.querySelector(".doboard_task_widget-concrete_issues-container");if((s||r)&&t){var s=window.scrollY,r=window.innerHeight,t=t.offsetTop,o=a.offsetHeight;let e;t-s<0?e=10:(r<t-s||r-o<(e=t-s))&&(e=r-o-10),a.style.top=e+"px",a.style.bottom="auto"}}handleScroll(){clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{this.positionWidgetContainer()},10)}handleResize(){clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.positionWidgetContainer()},100)}}var widgetTimeout=null;function openWidget(e,t,a){e&&!t&&new CleanTalkWidgetDoboard(e,a)}function taskAnalysis(e){return retrieveNodeFromPath(e?e.nodePath:"")}function scrollToNodePath(e){e=retrieveNodeFromPath(e);return!(!e||!e.scrollIntoView||(e.scrollIntoView({behavior:"smooth",block:"center"}),0))}function hideContainersSpinner(){var t=document.getElementsByClassName("doboard_task_widget-spinner_wrapper_for_containers");if(0<t.length)for(let e=0;e<t.length;e++)t[e].style.display="none";var a=["doboard_task_widget-all_issues-container","doboard_task_widget-concrete_issues-container"];for(let e=0;e<a.length;e++){var s=document.getElementsByClassName(a[e]);if(0<s.length)for(let e=0;e<s.length;e++)s[e].style.display="block"}}function getAvatarData(e){let t,a;var s=e.taskAuthorName&&"Anonymous"!=e.taskAuthorName?e.taskAuthorName.trim().charAt(0).toUpperCase():null;e.hasOwnProperty("userIsIssuer")&&e.userIsIssuer;let r="doboard_task_widget-avatar-initials";return null===e.taskAuthorAvatarImgSrc&&null!==s&&(t="display: flex;background-color: #f8de7e;justify-content: center;align-items: center;",a="doboard_task_widget-avatar_container"),null===e.taskAuthorAvatarImgSrc&&null===s&&(t="background-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAE9GlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgOS4wLWMwMDAgNzkuMTcxYzI3ZmFiLCAyMDIyLzA4LzE2LTIyOjM1OjQxICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjQuMCAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjQtMDQtMTBUMTk6MDg6MDkrMDU6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDI0LTA0LTEwVDE5OjIxOjA4KzA1OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDI0LTA0LTEwVDE5OjIxOjA4KzA1OjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoxNWRjOWI0Yy04ZWVmLTRkNTEtYmE0MS1kOTkzZTZmNjNmMTIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTVkYzliNGMt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');",a="doboard_task_widget-avatar_container",r+=" doboard_task_widget-hidden_element"),null!==e.taskAuthorAvatarImgSrc&&(t=`background-image:url('${e.taskAuthorAvatarImgSrc}');`,a="doboard_task_widget-avatar_container",r="doboard_task_widget-hidden_element"),{avatarStyle:t,avatarCSSClass:a,taskAuthorInitials:s,initialsClass:r}}function isAnyTaskUpdated(t){var a=[];for(let e=0;e<t.length;e++){var s=t[e],r=localStorage.getItem("spotfix_user_id");s.taskId&&s.taskLastUpdate&&s.taskCreatorTaskUser===r&&storageCheckTaskUpdate(s.taskId,s.taskLastUpdate)&&a.push(s.taskId.toString())}return 0!==a.length&&a}async function checkIfTasksHasSiteOwnerUpdates(e,t){var a=isAnyTaskUpdated(e);let s=!1;if(!a)return!1;for(let e=0;e<a.length;e++){var r,o,i=a[e];"string"==typeof i&&(o=await getTaskFullDetails(t,i)).issueComments&&(r=o.issueComments.length-1,(o=o.issueComments[r]).commentUserId!==localStorage.getItem("spotfix_user_id"))&&"Anonymous"!==o.commentAuthorName&&(storageAddUnreadUpdateForTaskID(i),s=!0)}return s}function getSelectedImage(e){if(e&&0!==e.rangeCount&&!e.isCollapsed){let t=e.getRangeAt(0);if(t.startContainer===t.endContainer&&t.startContainer.nodeType===Node.ELEMENT_NODE&&"IMG"===t.startContainer.tagName)return t.startContainer;e=document.createTreeWalker(t.commonAncestorContainer,NodeFilter.SHOW_ELEMENT,{acceptNode:function(e){return"IMG"===e.tagName&&isElementInRange(e,t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}).nextNode();if(e)return e;var a,e=getElementFromNode(t.startContainer),s=getElementFromNode(t.endContainer);if(e&&"IMG"===e.tagName&&isElementPartiallySelected(e,t))return e;if(s&&"IMG"===s.tagName&&isElementPartiallySelected(s,t))return s;for(a of findNearbyElements(t))if("IMG"===a.tagName)return a}return null}function isElementInRange(e,t){var a=document.createRange();return a.selectNode(e),t.compareBoundaryPoints(Range.START_TO_START,a)<=0&&0<=t.compareBoundaryPoints(Range.END_TO_END,a)}function isElementPartiallySelected(e,t){e=e.getBoundingClientRect(),t=t.getBoundingClientRect();return!(e.right<t.left||e.left>t.right||e.bottom<t.top||e.top>t.bottom)}function getElementFromNode(e){return e.nodeType===Node.ELEMENT_NODE?e:e.parentElement}function findNearbyElements(t){var a=[],e=t.commonAncestorContainer,s=e.previousElementSibling,r=e.nextElementSibling;if(s&&a.push(s),r&&a.push(r),e.nodeType===Node.ELEMENT_NODE){var o=e.children;for(let e=0;e<o.length;e++)isElementPartiallySelected(o[e],t)&&a.push(o[e])}return a}function getSelectedData(e){var{anchorOffset:t,focusOffset:a}=e;let s=e.toString(),r=!1;var o=getSelectedImage(e),i=window.location.href;if(!s){if(null===o)return createEmptySelectionData(i);s=`${o.tagName.toUpperCase()} ${e.anchorNode.offsetHeight.toString()} * `+e.anchorNode.offsetWidth.toString()}o&&(r=o.tagName);var n=0===t&&0===a&&0<s.length,e=determineTargetNode(e,n,r,o);return{startSelectPosition:Math.min(t,a),endSelectPosition:Math.max(t,a),selectedText:s,pageURL:i,nodePath:calculateNodePath(e),isTagOfImageType:r,isWholeTagSelected:n}}function determineTargetNode(e,t=!1,a=!1,s=null){var{focusNode:e,anchorNode:r}=e;return t?r.parentElement:a&&s?s:"#text"!==e.nodeName?e:e.parentNode}function calculateNodePath(a){for(var s=[];a;){let e=0,t=a.previousSibling;for(;t;)1===t.nodeType&&e++,t=t.previousSibling;s.unshift(e),a=a.parentNode}return s.shift(),s}function retrieveNodeFromPath(t){if(!t)return null;let a=document;for(let e=0;e<t.length;e++)if(!(a=a.children[t[e]]))return null;return a}function createEmptySelectionData(e){return{startSelectPosition:0,endSelectPosition:0,selectedText:"",pageURL:e,nodePath:"",isWholeTagSelected:!1,isTagOfImageType:!1}}function storageGetWidgetIsClosed(){return"1"===localStorage.getItem("spotfix_widget_is_closed")}function storageWidgetCloseIsSet(){return null!==localStorage.getItem("spotfix_widget_is_closed")}function storageSetWidgetIsClosed(e){localStorage.setItem("spotfix_widget_is_closed",e?"1":"0")}function storageGetUserIsDefined(){return null!==localStorage.getItem("spotfix_user_id")}function storageSaveTasksUpdateData(e){if(e&&Array.isArray(e)){let t=JSON.parse(localStorage.getItem("spotfix_task_updates")||"{}");e.forEach(e=>{e.taskId&&e.taskLastUpdate&&(t[e.taskId]={taskId:e.taskId,taskLastUpdate:e.taskLastUpdate})}),localStorage.setItem("spotfix_task_updates",JSON.stringify(t))}}function storageCheckTaskUpdate(e,t){return e&&t?!!(e=JSON.parse(localStorage.getItem("spotfix_task_updates")||"{}")[e])&&new Date(e.taskLastUpdate)<new Date(t):null}function storageAddUnreadUpdateForTaskID(e){var t;e&&((t=JSON.parse(localStorage.getItem("spotfix_unread_updates")||"[]")).includes(e)||t.push(e),localStorage.setItem("spotfix_unread_updates",JSON.stringify(t)))}function storageRemoveUnreadUpdateForTaskID(t){if(t){let e=JSON.parse(localStorage.getItem("spotfix_unread_updates")||"[]");e=e.filter(e=>e!==t),localStorage.setItem("spotfix_unread_updates",JSON.stringify(e))}}function storageTasksHasUnreadUpdates(){return 0<JSON.parse(localStorage.getItem("spotfix_unread_updates")||"[]").length}function storageProvidedTaskHasUnreadUpdates(e){return!!e&&JSON.parse(localStorage.getItem("spotfix_unread_updates")||"[]").includes(e.toString())}document.addEventListener("DOMContentLoaded",()=>{new CleanTalkWidgetDoboard({},"wrap")}),document.addEventListener("selectionchange",function(e){widgetTimeout&&clearTimeout(widgetTimeout),widgetTimeout=setTimeout(()=>{var e=window.getSelection();"Range"===e.type&&openWidget(getSelectedData(e),document.querySelector(".doboard_task_widget-container"),"create_issue")},1e3)});
//# sourceMappingURL=doboard-widget-bundle.min.js.map
